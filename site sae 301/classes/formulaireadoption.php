<?php require_once __DIR__ . '/classes/Adoption.php';require_once __DIR__ . '/classes/Database.php';$db=(new Database())->getConnection();$adoption=new Adoption($db);$chat_id=$_GET['id']??null;if($chat_id){$query="SELECT * FROM animaux WHERE id = :chat_id LIMIT 1";$stmt=$db->prepare($query);$stmt->bindParam(':chat_id',$chat_id);$stmt->execute();$animal=$stmt->fetch(PDO::FETCH_ASSOC);if(!$animal){echo"Animal non trouvé.";exit();}}else{echo"ID de l'animal manquant.";exit();}if($_SERVER['REQUEST_METHOD']==='POST'){header('Content-Type: application/json');$prenom=filter_input(INPUT_POST,'prenom',FILTER_SANITIZE_STRING);$nom_famille=filter_input(INPUT_POST,'nom_famille',FILTER_SANITIZE_STRING);$date_naissance=filter_input(INPUT_POST,'date_naissance',FILTER_SANITIZE_STRING);$email=filter_input(INPUT_POST,'email',FILTER_SANITIZE_EMAIL);$telephone=filter_input(INPUT_POST,'telephone',FILTER_SANITIZE_STRING);$message=filter_input(INPUT_POST,'message',FILTER_SANITIZE_STRING);if($prenom&&$nom_famille&&$date_naissance&&$email&&$telephone&&$message){if($adoption->creerDemande($chat_id,$prenom,$nom_famille,$date_naissance,$email,$telephone,$message)){echo json_encode(["status"=>"success"]);exit();}else{echo json_encode(["status"=>"error","message"=>"Erreur lors de l'insertion."]);exit();}}else{echo json_encode(["status"=>"error","message"=>"Données invalides."]);exit();}}?><!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"><title>Demande d'Adoption</title><script>function showPopup(msg,isSuccess){const p=document.createElement('div');p.style.position='fixed';p.style.top='50%';p.style.left='50%';p.style.transform='translate(-50%, -50%)';p.style.padding='20px';p.style.backgroundColor=isSuccess?'green':'red';p.style.color='white';p.style.borderRadius='10px';p.style.fontSize='18px';p.style.textAlign='center';p.textContent=msg;document.body.appendChild(p);setTimeout(()=>{p.remove();},5000);}document.addEventListener("DOMContentLoaded",function(){document.getElementById('adoptionForm').addEventListener('submit',function(e){e.preventDefault();const f=new FormData(this);fetch('formulaireadoption.php?id=<?= $animal['id'];?>',{method:'POST',body:f}).then(r=>r.json()).then(d=>{if(d.status==='success'){showPopup("Votre demande a été envoyée avec succès.",true);}else{showPopup(d.message||"Erreur lors de l'envoi.",false);}}).catch(()=>{showPopup("Erreur de connexion.",false);});});});</script></head><body><h1>Demande d'Adoption pour <?=htmlspecialchars($animal['nom']);?></h1><img src="<?=htmlspecialchars($animal['photo']);?>" alt="Photo de <?=htmlspecialchars($animal['nom']);?>" width="200"><p><strong>Espèce :</strong><?=htmlspecialchars($animal['espece']);?></p><p><strong>Race :</strong><?=htmlspecialchars($animal['race']);?></p><p><strong>Description :</strong><?=nl2br(htmlspecialchars($animal['description']));?></p><p><strong>Sexe :</strong><?=htmlspecialchars($animal['sexe']);?></p><form id="adoptionForm" method="POST"><input type="hidden" name="chat_id" value="<?=htmlspecialchars($animal['id']);?>"><label for="prenom">Prénom :</label><input type="text" id="prenom" name="prenom" required><br><label for="nom_famille">Nom de famille :</label><input type="text" id="nom_famille" name="nom_famille" required><br><label for="date_naissance">Date de naissance :</label><input type="date" id="date_naissance" name="date_naissance" required><br><label for="email">Email :</label><input type="email" id="email" name="email" required><br><label for="telephone">Téléphone :</label><input type="text" id="telephone" name="telephone" required><br><label for="message">Message :</label><textarea id="message" name="message" rows="4" required></textarea><br><button type="submit">Envoyer la Demande</button></form></body></html>